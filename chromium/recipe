pkg=chromium
ver=58.0.3029.81
_ver=3
rel=1
sum="The open-source project behind Google Chrome, an attempt at creating a safer, faster, and more stable browser"
lic=BSD
url=http://www.chromium.org
dep=(nss alsa-lib xdg-utils bzip2 libevent libxss libexif libgcrypt systemd dbus pciutils pulseaudio harfbuzz libsecret perl desktop-file-utils hicolor-icon-theme flac speech-dispatcher snappy perl-file-basedir libvpx)
mkd=(gperf yasm mesa python ninja nodejs)
src=(https://commondatastorage.googleapis.com/chromium-browser-official/chromium-$ver.tar.xz
     chromium-launcher-$_ver.tar.gz::https://github.com/foutrelis/chromium-launcher/archive/v$_ver.tar.gz)
sha=(5ab61b7025a5143fa1b21713479b316ec7a98e262e79e84f9c9a9656179217cb
     8b01fb4efe58146279858a754d90b49e5a38c9a0b36a1f84cbb7d12f92b84c28)

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for GNUrama Linux use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact gnuramalinux@gmail.com for
# more information.
_google_api_key=AIzaSyDtErDifxpCAXz1uPYJdEoniNZw83GCu4g
_google_default_client_id=624717512760-4jjho55j7kh3olr80odmlgpdh08b24pv.apps.googleusercontent.com
_google_default_client_secret=Wp_RyU401ZQFBxofwgD5KBbN

build() {
    cd $pkg-$ver

    # Enable support for the Widevine CDM plugin
    sed "s/@WIDEVINE_VERSION@/Pinkie Pie/" $rcsdir/chromium-widevine.patch | patch -Np1

    # Build fix from Gentoo
    patch -Np1 -i $rcsdir/chromium-system-ffmpeg-r4.patch
    patch -Np1 -i $rcsdir/chromium-gn-bootstrap-r2.patch

    mkdir -p third_party/node/linux/node-linux-x64/bin
    ln -s /usr/bin/node third_party/node/linux/node-linux-x64/bin/

    local _flags=(
        'is_clang=false'
        'clang_use_chrome_plugins=false'
        'is_debug=false'
        'fatal_linker_warnings=false'
        'treat_warnings_as_errors=false'
        'fieldtrial_testing_like_official_build=true'
        'remove_webcore_debug_symbols=true'
        'ffmpeg_branding="Chrome"'
        'proprietary_codecs=true'
        'link_pulseaudio=true'
        'linux_use_bundled_binutils=false'
        'use_gconf=false'
        'use_gnome_keyring=false'
        'use_gold=false'
        'use_sysroot=false'
        'enable_hangout_services_extension=true'
        'enable_widevine=true'
        "enable_nacl=false"
        "google_api_key=\"${_google_api_key}\""
        "google_default_client_id=\"${_google_default_client_id}\""
        "google_default_client_secret=\"${_google_default_client_secret}\""
    )

    python tools/gn/bootstrap/bootstrap.py --gn-gen-args "${_flags[*]}"
    out/Release/gn gen out/Release --args="${_flags[*]}"

    ninja -C out/Release chrome chrome_sandbox chromedriver

    cd ../chromium-launcher-$_ver
    make PREFIX=/usr
}

package() {
    cd chromium-launcher-$_ver

    make PREFIX=/usr DESTDIR=$pkgdir install-strip

    cd ../$pkg-$ver

    install -D out/Release/chrome $pkgdir/usr/lib/chromium/chromium

    install -Dm4755 out/Release/chrome_sandbox \
            $pkgdir/usr/lib/chromium/chrome-sandbox

    cp -a out/Release/{chrome_{100,200}_percent,resources}.pak \
        out/Release/{*.bin,chromedriver,libwidevinecdmadapter.so,icudtl.dat} \
        out/Release/locales \
        $pkgdir/usr/lib/chromium/

    ln -s /usr/lib/chromium/chromedriver $pkgdir/usr/bin/chromedriver

    install -Dm644 out/Release/chrome.1 $pkgdir/usr/share/man/man1/chromium.1

    install -Dm644 $rcsdir/chromium.desktop \
    $pkgdir/usr/share/applications/chromium.desktop

    for size in 22 24 48 64 128 256; do
        install -Dm644 chrome/app/theme/chromium/product_logo_$size.png \
        $pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
    done

    for size in 16 32; do
        install -Dm644 chrome/app/theme/default_100_percent/chromium/product_logo_$size.png \
        $pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
    done
}
