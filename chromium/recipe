pkg=chromium
ver=53.0.2785.101
_ver=3
rel=1
sum="The open-source project behind Google Chrome, an attempt at creating a safer, faster, and more stable browser"
lic=BSD
url=http://www.chromium.org
dep=(nss alsa-lib xdg-utils bzip2 libevent libxss libexif libgcrypt systemd dbus pciutils pulseaudio harfbuzz libsecret perl desktop-file-utils hicolor-icon-theme flac speech-dispatcher snappy perl-file-basedir libvpx)
mkd=(gperf yasm mesa python ninja)
opt=(!strip)
src=(https://commondatastorage.googleapis.com/chromium-browser-official/chromium-$ver.tar.xz
     chromium-launcher-$_ver.tar.gz::https://github.com/foutrelis/chromium-launcher/archive/v$_ver.tar.gz)
sha=(df89c284b0109566acc6a5a1a84d94a5ab0509cc3a86a31299a50328991edcde
     8b01fb4efe58146279858a754d90b49e5a38c9a0b36a1f84cbb7d12f92b84c28)

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for GNUrama Linux use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact gnuramalinux@gmail.com for
# more information.
_google_api_key=AIzaSyDtErDifxpCAXz1uPYJdEoniNZw83GCu4g
_google_default_client_id=624717512760-4jjho55j7kh3olr80odmlgpdh08b24pv.apps.googleusercontent.com
_google_default_client_secret=Wp_RyU401ZQFBxofwgD5KBbN

build() {
    cd $pkg-$ver

    # Enable support for the Widevine CDM plugin
    sed "s/@WIDEVINE_VERSION@/Pinkie Pie/" $rcsdir/chromium-widevine.patch | patch -Np1

    # Disable MADV_FREE (if set by glibc)
    # https://bugzilla.redhat.com/show_bug.cgi?id=1361157
    patch -Np1 -i $rcsdir/chromium-52.0.2743.116-unset-madv_free.patch

    # Disable last_commit_position as we don't build from git repository
    patch -Np1 -i $rcsdir/chromium-53.0.2785.92-last-commit-position.patch

    touch chrome/test/data/webui/i18n_process_css_test.html

    sed 's|//third_party/usb_ids/usb.ids|/usr/share/hwdata/usb.ids|g' -i device/usb/BUILD.gn

    local _flags=(
        'is_debug=false'
        'symbol_level=0'
        'enable_widevine=true'
        'enable_hangout_services_extension=false'
        "ffmpeg_branding=\"ChromeOS\""
        'proprietary_codecs=true'
        "google_api_key=\"${_google_api_key}\""
        "google_default_client_id=\"${_google_default_client_id}\""
        "google_default_client_secret=\"${_google_default_client_secret}\""
        'fieldtrial_testing_like_official_build=false'
        "remove_webcore_debug_symbols=true"
        'use_gconf=false'
        "use_gio=false"
        "use_gnome_keyring=false"
        "use_gtk3=false"
        "use_pulseaudio=true"
        "link_pulseaudio=true"
        'use_kerberos=true'
        'use_cups=true'
        'use_sysroot=false'
        'use_gold=false'
        "use_allocator=\"none\""
        'linux_use_bundled_binutils=false'
        'fatal_linker_warnings=false'
        'treat_warnings_as_errors=false'
        "enable_nacl=false"
        "enable_nacl_nonsfi=false"
        'is_clang=false'
        'clang_use_chrome_plugins=false'
    )

    python tools/gn/bootstrap/bootstrap.py -v --gn-gen-args "${_flags[*]}"
    out/Release/gn gen out/Release -v --args="${_flags[*]}"

    ninja -C out/Release chrome chrome_sandbox chromedriver

    cd ../chromium-launcher-$_ver
    make PREFIX=/usr
}

package() {
    cd chromium-launcher-$_ver

    make PREFIX=/usr DESTDIR=$pkgdir install-strip

    cd ../$pkg-$ver

    install -D out/Release/chrome $pkgdir/usr/lib/chromium/chromium

    install -Dm4755 out/Release/chrome_sandbox \
            $pkgdir/usr/lib/chromium/chrome-sandbox

    install -D out/Release/chromedriver $pkgdir/usr/lib/chromium/chromedriver

    cp out/Release/{*.pak,*.bin,libwidevinecdmadapter.so} \
        $pkgdir/usr/lib/chromium/

    # Manually strip binaries
    strip --strip-all $pkgdir/usr/lib/chromium/{chromium,chrome-sandbox} \
                      $pkgdir/usr/lib/chromium/chromedriver
    strip --strip-unneeded $pkgdir/usr/lib/chromium/libwidevinecdmadapter.so

    cp -a out/Release/locales $pkgdir/usr/lib/chromium/

    install -Dm644 out/Release/chrome.1 $pkgdir/usr/share/man/man1/chromium.1

    install -Dm644 $rcsdir/chromium.desktop \
    $pkgdir/usr/share/applications/chromium.desktop

    for size in 22 24 48 64 128 256; do
        install -Dm644 chrome/app/theme/chromium/product_logo_$size.png \
        $pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
    done

    for size in 16 32; do
        install -Dm644 chrome/app/theme/default_100_percent/chromium/product_logo_$size.png \
        $pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
    done

    ln -s /usr/lib/chromium/chromedriver $pkgdir/usr/bin/chromedriver

    install -Dm644 out/Release/icudtl.dat $pkgdir/usr/lib/chromium/icudtl.dat
}
