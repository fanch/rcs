pkg=openvpn
ver=2.4.0
rel=1
sum="An easy-to-use, robust, and highly configurable VPN (Virtual Private Network)"
lic=custom
url=http://openvpn.net/index.php/open-source.html
dep=(openssl lzo iproute2 systemd pkcs11-helper)
src=(https://swupdate.openvpn.net/community/releases/$pkg-$ver.tar.xz)
sha=(6f23ba49a1dbeb658f49c7ae17d9ea979de6d92c7357de3d55cd4525e1b2f87e)

build() {
    # plugin path
    patch -Np1 < $rcsdir/0001-plugin.patch

    # do not race on RuntimeDirectory
    patch -Np1 < $rcsdir/0002-do-not-race-on-RuntimeDirectory.patch

    # fix timeout in non-TLS mode with systemd
    patch -Np1 < $rcsdir/0003-fix-timeout-in-non-TLS-mode-with-systemd.patch

    # regenerate configure script
    autoreconf -fi

    ./configure --prefix=/usr \
                --sbindir=/usr/bin \
                --enable-iproute2 \
                --enable-pkcs11 \
                --enable-plugins \
                --enable-systemd \
                --enable-x509-alt-username
    make
}

package() {
    make DESTDIR=$pkgdir install

    # Create empty configuration directories
    install -d -m0750 -g 90 $pkgdir/etc/openvpn/{client,server}

    # Install examples
    install -d -m0755 $pkgdir/usr/share/openvpn
    cp -r sample/sample-config-files $pkgdir/usr/share/openvpn/examples

    # Install license
    install -d -m0755 $pkgdir/usr/share/licenses/$pkg/
    ln -sf /usr/share/doc/$pkg/{COPYING,COPYRIGHT.GPL} $pkgdir/usr/share/licenses/$pkg/

    # Install contrib
    for FILE in $(find contrib -type f); do
        case "$(file --brief --mime-type "${FILE}")" in
            "text/x-shellscript") install -D -m0755 "${FILE}" $pkgdir/usr/share/openvpn/${FILE} ;;
            *) install -D -m0644 "${FILE}" $pkgdir/usr/share/openvpn/${FILE} ;;
        esac
    done

    # Install systemd files
    install -d -m0755 $pkgdir/usr/lib/systemd/system/
    install -m0644 distro/systemd/openvpn-{client,server}@.service $pkgdir/usr/lib/systemd/system/
    install -D -m0644 distro/systemd/openvpn.conf $pkgdir/usr/lib/tmpfiles.d/openvpn.conf
    install -d -m0710 $pkgdir/run/openvpn-{client,server}
}
