pkg=linux
ver=4.6.5
rel=1
sum="The Linux kernel and modules"
lic=GPL2
url=http://www.kernel.org
grp=base
dep=(coreutils kmod dracut)
mkd=(bc)
opt=(!strip)
#src=(https://www.kernel.org/pub/linux/kernel/v4.x/linux-${ver:0:3}.tar.xz)
src=(https://www.kernel.org/pub/linux/kernel/v4.x/linux-$ver.tar.xz)
sha=(7e2d53c8a36a159c444be8f452eae898fadc1f1862fe470a36c836c3d1d613c5)

build() {
    patch -Np1 -i $rcsdir/change-default-console-loglevel.patch

    cp -v $rcsdir/config .config

    # don't run depmod on 'make install'.
    sed -i '2iexit 0' scripts/depmod.sh

    make prepare
    yes "" | make config >/dev/null

    make bzImage modules
}

package() {
    kver=$(make LOCALVERSION= kernelrelease)

    mkdir -p $pkgdir/{lib/modules,lib/firmware,boot}

    make INSTALL_MOD_PATH=$pkgdir modules_install

    # remove firmware folder, build and source links
    rm -f $pkgdir/lib/modules/$kver/{source,build}
    rm -rf $pkgdir/lib/firmware

    # run depmod
    depmod -b $pkgdir -F System.map $kver

    mkdir $pkgdir/usr; mv $pkgdir/lib $pkgdir/usr/

    cp arch/x86/boot/bzImage $pkgdir/boot/vmlinuz
}
