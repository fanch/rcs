pkg=networkmanager
ver=1.6.2
rel=1
sum="Network Management daemon"
lic="GPL2, LGPL2.1"
url=http://www.gnome.org/projects/NetworkManager
dep=(libndp libsoup modemmanager polkit iproute2 libgudev wpa_supplicant dbus-glib util-linux nss dhcp jansson bluez)
mkd=(gobject-introspection intltool iptables gtk-doc vala ppp perl-yaml)
bak=(/etc/NetworkManager/NetworkManager.conf)
src=(https://download.gnome.org/sources/NetworkManager/${ver:0:3}/NetworkManager-$ver.tar.xz)
sha=(b22b6f55cde37bec4982f9be4b1808a21101d807a05049c670116d95059a26f9)
_pppver=2.4.7

build() {
    NOCONFIGURE=1 ./autogen.sh

    ./configure --prefix=/usr \
                --sysconfdir=/etc \
                --localstatedir=/var \
                runstatedir=/run \
                --sbindir=/usr/bin \
                --disable-ifcfg-rh \
                --disable-ifcfg-suse \
                --disable-ifnet \
                --disable-ifupdown \
                --disable-lto \
                --disable-more-warnings \
                --disable-static \
                --enable-bluez5-dun \
                --enable-concheck \
                --enable-config-plugin-ibft \
                --enable-gtk-doc \
                --enable-introspection \
                --enable-json-validation \
                --enable-ld-gc \
                --enable-modify-system \
                --enable-polkit \
                --enable-polkit-agent \
                --enable-wifi \
                --with-config-dhcp-default=dhclient \
                --with-config-dns-rc-manager-default=resolvconf \
                --with-config-logging-backend-default=journal \
                --with-config-plugins-default=keyfile,ibft \
                --with-crypto=nss \
                --with-dbus-sys-dir=/usr/share/dbus-1/system.d \
                --with-dhclient=/usr/bin/dhclient \
                --with-dnsmasq=/usr/bin/dnsmasq \
                --with-dnssec-trigger=/usr/lib/dnssec-trigger \
                --with-hostname-persist=default \
                --with-iptables=/usr/bin/iptables \
                --with-kernel-firmware-dir=/usr/lib/firmware \
                --with-libnm-glib \
                --with-libsoup \
                --with-modem-manager-1 \
                --with-nmcli \
                --with-pppd-plugin-dir=/usr/lib/pppd/$_pppver \
                --with-pppd=/usr/bin/pppd \
                --with-resolvconf=/usr/bin/resolvconf \
                --with-session-tracking=systemd \
                --with-suspend-resume=systemd \
                --with-system-ca-path=/etc/ssl/certs \
                --with-systemd-journal \
                --with-systemd-logind \
                --with-systemdsystemunitdir=/usr/lib/systemd/system \
                --with-udev-dir=/usr/lib/udev \
                --with-wext \
                --without-consolekit \
                --without-dhcpcd \
                --without-libaudit \
                --without-netconfig \
                --without-ofono \
                --without-selinux
    make
}

package() {
    make DESTDIR=$pkgdir install

    install -dm700 $pkgdir/etc/NetworkManager/system-connections
    install -d $pkgdir/etc/NetworkManager/{conf,dnsmasq}.d
    install -m644 $rcsdir/NetworkManager.conf $pkgdir/etc/NetworkManager
    install -Dm644 $rcsdir/20-connectivity.conf \
        $pkgdir/usr/lib/NetworkManager/conf.d/20-connectivity.conf

    # disable mac spoofing
    install -Dm644 $rcsdir/30-mac-randomization.conf \
        $pkgdir/usr/lib/NetworkManager/conf.d/30-mac-randomization.conf
}
